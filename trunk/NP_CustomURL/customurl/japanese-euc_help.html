<h3>プラグインの概要</h3>

<p>

NucleusCMSで作成したwebサイトのアイテム・カテゴリに好きな名前をつけて、静的URLとしてリンクを生成します。<br />
<em style="color:#cc0000;">FancyURLモードでのみの動作、及びmod_Rewrite必須です</em><br />
カテゴリ、サブカテゴリ、アーカイブリスト等を、それぞれディレクトリとみなし、カテゴリで絞り込んだ時は当該カテゴリのディレクトリにあるindexファイルを参照するイメージになります<br />
<ul style="margin:0 0 25px 12px;">ex.
<li>カテゴリへのアクセスのイメージ:
<ul><li>http://example.jp/nucleuscms/</li></ul></li>
<li>サブカテゴリへのアクセスのイメージ:
<ul><li>http://example.jp/nucleuscms/plugins/</li></ul></li>
<li>アーカイブへのアクセスのイメージ:
<ul><li>http://example.jp/archives/</li><li>http://example.jp/archives/nucleuscms/</li></ul></li>
</ul>
メンバーの詳細ページと個別アイテムページは、当該htmlファイルにアクセスするイメージになります<br />
<ul style="margin:0 0 25px 12px;">ex.
<li>http://example.jp/nucleuscms/plugins/NP_CustomURL.html</li>
<li>http://example.jp/new_nucleus_comming_soon.html</li>
<li>http://example.jp/member/Hiroyuki.html</li>
</ul>

</p>

<h3>インストール・動作開始手順</h3>

<p>

<ol style="margin:0 0 25px 12px;">
<li>ダウンロードしたファイルを解凍して出来た「NP_CustomURL.php」ファイルと「customurl」ディレクトリをサーバの plugins ディレクトリにアップロード後、「プラグインの管理」ページで「CustomURL」を選択して「プラグインのインストール」ボタンをクリックします<br />
(この文章を読んでいるということは、ここまでは出来ていると思います)</li>
<li>まず始めに、管理画面の「グローバル設定」ページで「URL モード」を「Fancy」に変更します</li>
<li>通常の「extra」ディレクトリの「fancyurls.config.php」を、FancyURLsの手順通りトップディレクトリへコピーして編集します<br />このときコピーするのは「fancyurls.config.php」ファイルだけで、後のファイルはコピーする必要がありません</li>
<li>次に「index.php」を編集しますの <code>$CONF['Self']</code> の行を <code>$CONF['Self'] = '.'</code> に書き換え、 <code>$curl_blogid = 1;</code>("1"は「index.php」でアクセスするブログのID) と一行書き加えます
<blockquote><pre style="overflow:auto;">&lt;?php
// This file will generate and return the main page of the site
$CONF = array();
$CONF['Self'] = '.';
$curl_blogid = 1;

include('./config.php');
include('./fancyurls.config.php');

selector();

?&gt;
</pre></blockquote>
</li>
<li>次に<code>.htaccess</code>を編集します<ul>
    <li>内容はこちら<blockquote><pre style="overflow:auto;">RewriteEngine on
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?curl=$1 [L,QSA]
</pre></blockquote>
この4行だけで、後は何も書かなくても大丈夫です</li></ul></li>
</ol>
これで準備完了です<br />
<br />
注1：現在 FancyURLs で運用されている方は、Fancy 用のファイルを削除するか別ディレクトリへ退避してください。すべてこのプラグインで受けているので必要ありません<br />
また、下記プラグイン用のFancyファイルは組み込み済みですので不要です
<ul>
<li>各ページスイッチ用「page」ファイル</li>
<li>タグ用「tag」ファイル(「NP_TagEX」「NP_MultiTags」両方対応。「NP_MultiTags」の「タグクエリー 」の変更にも対応しています)</li>
<li>「NP_Trackback」のトラックバック受信専用「trackback」ファイル</li>
</ul>
</p>

<h3>使い方</h3>

<p>

<ul>
<li style="margin-top:3px;">ブログ・アイテム・カテゴリ・メンバーの編集ページにそれぞれオプションが追加してありますので、好きな名前をつけてください</li>
<li style="margin-top:3px;">メンバーの新規追加、及び「ブログの設定の編集」ページからのカテゴリの新規追加の時にはこれらの編集画面が出ませんので、追加したあとにそれぞれ編集してください</li>
<li style="margin-top:3px;">新規追加時のデフォルトの名前は、ブログは[ショートネーム]カテゴリーは[category_(catid)]、アイテムは[item.html]、メンバーは[ログインネーム.html]がそれぞれ設定されます<br />
	なお、プラグインのインストール時にブログに存在した全てのブログ・アイテム・カテゴリ・メンバーには自動でパスを生成済みです</li>
<li style="margin-top:3px;">同一ブログ内、同一キーでの名前は重複できませんので気をつけてください<br />
	登録しようとしたパスが重複していた場合は、末尾にそれぞれのIDが'_id'の形で追加されます<br />
	同一ブログであっても、カテゴリーとサブカテゴリー、アイテムは同じ名前をつけることが出来ます<br />
	つまり、http://example.jp/nucleuscms/nucleuscms/nucleuscms.htmlは有効なパスとなります</li>
<li style="margin-top:3px;">メンバー、及びアイテムのパスには、末尾に自動的に[.html]が付加されるので、編集時に[.html]をつけないように気をつけてください<br />
	うっかり付けてしまうと、[item_html.html]というような、なんだかよく解らないファイル名が出来上がってしまいます</li>
<li style="margin-top:3px;">メンバーディレクトリ、アーカイブディレクトリ、アーカイブリストディレクトリはプラグインの編集画面で変更できます。初期値はそれぞれの<code>$CONF['***Key']</code>の値になっています</li>
<li style="margin-top:3px;">ディレクトリ名、及びファイル名として使用できる文字は半角英数字(a-z,A-Z,0-9)と半角ハイフン(-)と半角アンダーバー(_)のみです<br />
	なお、指定された文字列の中に含まれている '/'(スラッシュ)や'.'(ピリオド)は、自動的に '_'(半角アンダーバー)に変換されますが、それ以外のときはエラーを返します<br />
	URL生成のときはアルファベットの大文字小文字の区別はしますが、アクセスのときはURLの使用上区別できません<br />
	通常のHTMLリンク同様、 http://example.jp/NucleusCMS/ と表示してあるリンクに対し、ブラウザのアドレス欄に http://example.jp/nucleuscms/ でアクセス可能です</li>
<li style="margin-top:3px;">サブカテゴリ用のディレクトリ名は、現在管理画面でのみ編集可能です<br />
	新しく追加されたサブカテゴリについてはリンク生成のタイミングでデータベースを更新しているので、実用上問題ないと思います<br />
	デフォルトのサブカテゴリ用ディレクトリ名は[subcatid_(subid)]です</li>
<li style="margin-top:3px;">管理画面、編集画面でディレクトリ名を空白にした場合は、データベースからその名前が削除され、URLは従来のFancyURLsのものになります<br />
	(但しサブカテゴリーについては、追加・削除のタイミングがプラグイン側で判断できないため、「空白文字列 = デフォルト名」になります)</li>
<li style="margin-top:3px;">ブログアクセス用パスとカテゴリーアクセス用パスには同じ名前をつけることが出来ません<br />
	これは <code>hostname</code> の次に来るパス名がカテゴリのものであるのかブログのものであるのかを見分ける有効な手段が見つからないための制限です</li>
<li style="margin-top:3px;">トップディレクトリ直下に実在するディレクトリ名やファイル名をパスとして登録することは出来ますが、httpサーバは実在するものの方を返すので、このパスは事実上無効となります</li>
<li style="margin-top:3px;">このプラグインのインストール後でも、従来のクエリ式のURL(ex. http://example.jp/index.php?catid=123)やFancyURLs式のURL(ex. http://example.jp/category/12/item/34)でのアクセスは可能です</li>
<li style="margin-top:3px;">各ブログ毎にオプションで URI を変更する・しないを選択することが出来ます。このオプションを「使用しない」にした場合は、通常のFancyURLs(ex. http://example.jp/category/12/item/34)になります<br />
	また「使用しない」にした場合でも、生成される URI が FancyURLs になるだけで、カスタマイズされた URI でリクエストがあった場合のリンクは成立しますので、このプラグインの使用をやめる場合などは外部からのリンクの書き換えが全て終わるまで、このオプションで「使用しない」を選択した状態での運用によってスムーズに移行できると思います</li>
<li style="margin-top:3px;">デフォルトで生成されるURIの接頭語はオプション画面で変更できます</li>
<li style="margin-top:3px;">アイテムの接頭語のみ、<%year%>、<%month%>、<%day%>の各変数が使用できます<br />この値を<%month%>-<%day%>とした場合、アイテムの投稿時に自動で作成されるURIは「08-21_(id)」のようになります</li>
</ul>

</P>

<h3>スキン・テンプレート変数</h3>

<p>
スキン・テンプレート、及び記事中に記入することが出来ます<br />
記入方法：<code>&lt;%CustomURL(リンク先, リンク文字列, リンクタイトル)%&gt;</code><br />
<ul>
<li>リンク先：リンク先の種類/id または名前/指定種別
	<ul>
		<li>第一パラグラフ：i、c、s、b、m のいずれか。それぞれ、item、category、subcategory、blog、member の頭文字</li>
		<li>第二パラグラフ：リンク先の id、もしくは名前。名前はパス名ではなく、「カテゴリー名」「ブログの短縮名」等になります。リンク先にアイテムを選択した場合は、ここに指定できるのは id のみになります</li>
		<li>第三パラグラフ：第二パラグラフに id を指定した場合は 'i' 、名前を指定した場合は 'n' と記入してください</li>
	</ul>
</li>
<li>リンク文字列：a タグに挟まれる文字列。省略された場合は url のみが生成されます</li>
<li>リンクタイトル：a タグの「title」属性に設定されます。省略された場合は、リンク文字列が存在すれば変わりに設定されます。リンク文字列を指定せずにタイトルのみを指定してもリンクタグは生成されません</li>
<li>全てのパラメータを省略して&lt;%CustomURL%&gt;と書くことも出来ます。この場合は記入場所によってデフォルトの URI が書き出されます
	<ul>
		<li>スキン　　　：選択中の「ブログ」のトップページへの URI が書き出されますす</li>
		<li>テンプレート：書き出されるアイテムへの URI が書き出されます(&lt;%itemlink%&gt;の置き換え)</li>
		<li>記事中　　　：自分自身への URI が書き出されます</li>
	</ul>
</li>
</ul>
記入例：
<ul>
	<li>id が123のアイテムにリンクする場合：&lt;a href="&lt;%CustomURL(i/123/i)%&gt;"&gt;'ここは自由に書き込んでください'&lt;/a&gt;<br />
	書き出される文字列：&lt;a href="http://blog.example.jp/item_123.html"&gt;'ここは自由に書き込んでください'&lt;/a&gt;</li>
	<li>カテゴリー名が「日記」のカテゴリーの URI を書き出す場合：&lt;%CustomURL(c/日記/n)%&gt;<br />
	書き出される文字列(「日記」カテゴリーのidが12の場合)：http://blog.example.jp/category_12/</li>
	<li>ブログの短縮名「bibouroku」へのリンクを「このブログ」という文字列からのリンクに設定する場合：&lt;%CustomURL(c/bibouroku/n, このブログ)%&gt;<br />
	書き出される文字列：&lt;a href="http://blog.example.jp/"&gt;このブログ&lt;/a&gt;</li>
</ul>
スキン・テンプレート・記事共に、&lt;%CustomURL(123)%&gt;のように id のみを記入した場合は、その id を持つアイテムへの URI が書き出されます<br />
またアイテムの場合のみ、&lt;%CustomURL(123/path)%&gt;と書くことで、item_123 のようにその id を持つアイテムに設定したパスを書き出すことが出来ます<br />
</p>

<h3>動作報告・バグレポート</h3>

<p>動作報告・バグレポートは、以下のURLにコメント・トラックバックをお願いします<br />
<a href="http://shizuki.kinezumi.net/NucleusCMS/Plugins/NP_CustomURL/NP_CustomURL.html">
http://shizuki.kinezumi.net/NucleusCMS/Plugins/NP_CustomURL/NP_CustomURL.html</a></p>

<h3>バージョン履歴</h3>

<ul>
<li>Version 0.2.3: 不具合修正・機能追加
	<ul>
	<li>リダイレクト周りにバグがあったので修正</li>
	<li>「カスタマイズされたURLを使用する」を「はい」にしている時、旧来のFancuURLでアクセスしてきたクライアントに301を返してリダイレクトするように変更</li>
	</ul>
</li>
<li>Version 0.2.2a: 不具合修正
	<ul>
	<li>SQLインジェクションを引き起こす可能性がある脆弱性に対処</li>
	</ul>
</li>
<li>Version 0.2.2: 不具合修正・機能追加
	<ul>
	<li>バグフィックス</li>
	<li>アイテム・カテゴリー・サブカテゴリーの新規作成時のデフォルトの接頭語のオプションでの変更に対応<br />
	アイテムの接頭語のみテンプレート化</li>
	</ul>
</li>
<li>Version 0.2.1a: 不具合修正
	<ul>
	<li>バグフィックス</li>
	</ul>
</li>
<li>Version 0.2.1: 機能追加
	<ul>
	<li>サブカテゴリの多段URL化</li>
	<li>カテゴリ・ブログの削除時にサブカテゴリのデータが消去できていなかった不具合を修正</li>
	<li>その他修正</li>
	</ul>
</li>
<li>Version 0.1.9: 機能追加
	<ul>
	<li>カテゴリ及びアイテムのブログ間移動に対応</li>
	</ul>
</li>
<li>Version 0.1.8a: 不具合修正・機能追加
	<ul>
	<li>新規サブカテゴリのパス登録のタイミング変更に伴う修正</li>
	<li>ブログ毎にカスタマイズした URI を使用する・しないを選択できるようにオプションを追加</li>
	<li>ヘルプファイルの修正</li>
	</ul>
</li>
<li>Version 0.1.8: 不具合修正
	<ul>
	<li>新規ブログ作成時に自動で作成される'General'カテゴリーに対するURIが正常に動作しなかった不具合に対応</li>
	<li>ブログを削除した時に、削除したブログに属する「カテゴリー」「サブカテゴリー」「アイテム」のURIがテーブルに残ったままになっていた不具合に対応</li>
	<li>新規サブカテゴリーのパスの登録のタイミングをリンクが生成される時に変更(リンク生成前に管理画面でURIを設定していた場合は設定したURIが使用されます)</li>
	<li>管理ページでアイテムURIがおかしくなっていたのを修正</li>
	</ul>
</li>
<li>Version 0.1.7: 不具合修正
	<ul>
	<li>ほぼ全面的に書き直し</li>
	<li>新規アイテム追加時にトラックバックを送信した時に、トラックバック元のURLが正しく送信できなかった</li>
	<li>管理画面からサブカテゴリのパスを編集したときに、リストが表示されなかった</li>
	</ul>
</li>
<li>Version 0.1.5: 公開バージョン</li>
<li>Version 0.01: 初期バージョン(NP_Pathの改造バージョン)</li>
</ul>

<h3>謝辞</h3>
<p>
本プラグインの英語版ランゲージファイル、及びヘルプファイル作成に当たりまして、多大なるご協力をいただきましたTucker氏に心より感謝申し上げます
</p>

<h3>プラグイン改造情報</h3>

<p>

「NP_TagEX」と「NP_ContentsList」で 「http://example.jp/nucleuscms/plugins/tag/NP_CustomURL」 形式のリンクを表示させる方法<br />
<br />
「NP_TagEX」の場合<br />
・一番最後のファンクション<code>creatTagLink()</code>の最後の<code>return addLinkParams($link, $linkparams);</code>の直前に、次のコードを挿入します<br />
<blockquote><pre style="overflow:auto;">global $manager;
if ($manager->pluginInstalled('NP_CustomURL')) {
    $customurls = $manager->getPlugin('NP_CustomURL');
    $link = 'tag/' . $ready.$sep.$this->_rawencode($tag);
    return $CONF['BlogURL'] . '/' . $customurls->_addLinkParams($link, $linkparams) . '/';
}
</pre></blockquote>
これでタグがURLの一番最後になります<br />
<br />
「NP_ContentsList」の場合<br />
・<code>doSkinVar()</code>の467行目付近、<code>$catdata['catlink']</code>の生成が終了したところでサブカテゴリのリンクを生成する直前、
<blockquote><pre style="overflow:auto;">// sub category ---
if ($subcat && (!$subcurrent || $catid == $catdata['catid']) && !$subnoOpen) {
</pre></blockquote>
の前の行に
<blockquote><pre style="overflow:auto;">if ($CONF['URLMode'] == 'pathinfo' && $manager->pluginInstalled('NP_CustomURL')) {
    $catdata['catlink'] = createCategoryLink($catdata['catid']);
}
</pre></blockquote>の一行を追加して、カテゴリのリンクを上書きします<br />
さらにそこからもう少し下の
<blockquote><pre style="overflow:auto;">$subdata['sublink'] = addLinkParams($catdata['catlink'], array($subrequest => $subdata['subcatid']));
</pre></blockquote>
となっている行の下に
<blockquote><pre style="overflow:auto;">global $manager;
if ($CONF['URLMode'] == 'pathinfo' && $manager->pluginInstalled('NP_CustomURL')) {
    $customurls = $manager->getPlugin('NP_CustomURL');
    $subdata['sublink'] = $customurls->_addLinkParams($catdata['catlink'], array($subrequest => $subdata['subcatid']));
}
</pre></blockquote>
と追加、350行目付近の<code>$data['self'] = $data['blogurl'];</code>の前に
<blockquote><pre style="overflow:auto;">if ($CONF['URLMode'] == 'pathinfo' && $manager->pluginInstalled('NP_CustomURL')) {
    $data['blogurl'] = createBlogidLink($data['blogid']);
}
</pre></blockquote>
を追加して終了です

</p>
