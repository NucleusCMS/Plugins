<h3>Plugin概要 <a href="http://blog.cles.jp/np_cles/category/31/subcatid/2"><img border="0" src="http://blog.cles.jp/npmoblog.png"  alt="Powered by NP_Moblog" /></a>&nbsp;<a href="http://cles.jp/"><img border="0" src="http://blog.cles.jp/cles.png"  alt="Powered by CLES" /></a></h3>

<p>メールサーバからメールを取得しエントリとして追加するプラグインです。画像ファイル付きのメールにも対応しています。</p>

<h3>必要環境</h3>
<p>Nucleus: 3.2以降</p>
<p>PHP: 4.3.x以降</p>

<h3>ファイル構成</h3>

<p>インストール時の構成は以下の通りになります</p>

<p>
(Nucleusのpluginフォルダ)<br/>
├NP_Moblog.php<br/>
│├moblog/<br/>
│├index.php<br/>
│└help.html<br/>
└sharedlibs/<br/>
　└<em>PEAR/共通ライブラリ群</em>
</p>

<h3>最低限やらなければならないこと</h3>

<p><code>NP_Moblog</code>には開発の過程でたくさんのオプション（設定項目）が追加されてきました。</p>
<p>これらは全て<code>NP_Moblog</code>を快適に利用するためのものですが、<strong>はじめてお使いになる方はオプションの多さにビックリされている</strong>かもしれません。ここでは<code>NP_Moblog</code>を利用するために最低限やらなければならないことについて解説します。</p>

<p><strong>以下の手順に入る前に、NP_Moblog専用のメールアドレスを準備しておいてください。</strong></p>
<ol>
  <li>プラグインをインストールする<em>（このページが確認できれば、おそらくインストールは成功しています）</em></li>
  <li>「プラグイン管理」からNP_Moblogの「編集」を開く</li>
  <li>「メール取得の間隔(秒)」を0にする</li>
  <li>「オプションの保存」をクリックして内容を保存する</li>
  <li>「スキン編集」ページを開き、自分の使っているスキンへ&lt;%Moblog%&gt;を記入する。</li>
  <li>「あなたの設定」ページを開く</li>
  <li>「プラグインを有効にするか？」を<code>はい</code>に変更</li>
  <li>「POP3 ホスト名」「POP3 ユーザー名」「POP3 パスワード」にメールサーバの情報を設定。(NP_Moblogはここで指定したメールボックスの宛てのメールを取得して追加します。</li>
  <li>「Nucleusカテゴリ名(Blog名)」に投稿時に使われるカテゴリとblogを指定する。</li>
  <li>「投稿許可アドレス」にメール送信元のメールアドレスを設定する。</li>
  <li>「設定の変更」をクリックして記入内容を保存する。</li>
  <li>メールを送信して、&lt;%Moblog%&gt;を記入したページを表示する。</li>
</ol>

<p><em>上記で設定しなかったオプションには通常の使用において十分であると考えられる初期値が設定済みになっています。</em></p>

<p>投稿されない場合には「管理操作履歴」を確認してみてください。
投稿はされるが表示が崩れたりする場合にはテンプレートを調整するとよいでしょう。
また、投稿が成功したら上記の3で設定した「メール取得の間隔(秒)」を600に戻しておきましょう。</p>

<h3>メールタイトルにオプションを記述する方法</h3>

<p>受信したメールは「メンバーオプション」に設定されている内容にしたがって処理されますが、メールのタイトルにオプションを記述することによってそのメールだけ特別な処理をすることができます。</p>

<p>メールタイトルによって変更可能なオプション</p>
<ol>
  <li>「Nucleus blog Id」</li>
  <li>「Nucleus カテゴリ」</li>
  <li>「デフォルトで公開するか？」</li>
</ol>

<p>例えばデフォルトの設定でタイトルを「新規アイテムのタイトル@b=2&amp;c=books&amp;s=1」とした場合、メンバー設定にかかわらず以下のような処理が行われます。</p>
<ol>
  <li>「Nucleus blog Id」は2</li>
  <li>「Nucleus カテゴリ」はbooks</li>
  <li>「デフォルトで公開するか？」が1 <em>(すぐに公開)</em></li>
</ol>

<p>カテゴリの名前が間違っているときは、指定されたblogのデフォルトのカテゴリとなります。
存在しないblogが指定されたときは、追加を行いません。（ログにエラーが記録されます） </p>

<p>オプション記述方法(デフォルト時)</p>
<ol>
  <li>オプションの記述開始は半角@</li>
  <li>値を=で結び、間は&amp;</li>
  <li>「Nucleus blog Id」のキーは&quot;b&quot;</li>
  <li>「Nucleus カテゴリ」のキーは&quot;c&quot;</li>
  <li>「デフォルトで公開するか？」のキーは&quot;s&quot;</li>
</ol>

<h3>スキンへの記述</h3>

<p>インストールを行っただけではメールの取得は行われません。</p>
<p>スキン中に以下のタグを記述することにより、メールの取得が行われるようになります。</p>

<table>
<tr>
	<th>タグ</th>
	<th>解説</th>
</tr>
<tr>
	<td>&lt;%Moblog%&gt;</td>
	<td>このページが表示されるときにメールの取得を行います。<br />
	前回の取得処理からプラグインオプションで設定してある「メール取得の間隔(秒)」以上の時間が経過していない場合には取得処理を行いません。
	</td>
</tr>
<tr>
	<td>&lt;%Moblog(link)%&gt;</td>
	<td>メンバーが<strong>ログインした状態</strong>でこのスキンを表示すると<code>Add Item by Mail</code>というリンクが出現します。これをクリックすることにより、メールの取得処理を行うことができます。<br />
	これは上記と違い、必ずメール取得処理を行います。
	</td>
</tr>
</table>

<h3>オプション</h3>

<p><code>NP_Moblog</code>には２種類のオプションがあります</p>
<ol>
  <li>「プラグイン管理」から設定できる「プラグインオプション」</li>
  <li>「あなたの設定」や「メンバー管理」からメンバーごとに設定できる「メンバーオプション」</li>
</ol>

<p>プラグインオプション（サイト全体の設定）</p>
<table>
<tr>
	<th>オプション</th>
	<th>解説</th>
</tr>
<tr>
	<td>動作モード</td>
	<td>
		動作モードを設定します。
		<ul>
		  <li>
		  	「互換モード」：通常はこちらを選択してください。
		  </li>
		  <li>
		  	「振分対応モード」：<strong>ひとつのメールアカウントを複数のメンバーで共有する</strong>場合にのみこちらを選択してください。<br />
		  	<br />
		  	メンバーオプション内の「投稿を許可するメールアドレス」に記載されていないアドレスから投稿があった場合に<strong>そのメールを削除しないようになります</strong>。
		  	したがって、誰も投稿許可にしていないメールアドレスから投稿があった場合、メールボックスにはどんどんゴミが溜まっていきます。
		  	この場合、<strong>予期せずメールボックスが満杯になる</strong>可能性がありますのでご注意ください。
		  </li>
		</ul>
		デフォルト:「互換モード」	
	</td>
</tr>
<tr>
	<td>SPAMチェックを有効にする</td>
	<td>	
		<code>NP_Blacklist</code>などによりメールのチェックを行います。SPAMと判定された場合にはメールは投稿されません。<br />
		別途、SPAM判定用のプラグインが必要です。<em>(<code>$manager->notify('SpamCheck',....)</code>に対応したもの)</em>
	</td>
</tr>
<tr>
	<td>メール取得の間隔(秒)</td>
	<td>
		<code>NP_Moblog</code>はスキンに<code>&lt;Moblog&gt;</code>と書かれたページにアクセスがあるとメールを取得するようになっています。しかしながら<code>&lt;Moblog&gt;</code>と書いてあるスキンへのアクセスが多い場合、プラグインはアクセスのたびにメールを取得するので、メールの連続取得による負荷が大きくなる場合があります。そのような状況を回避するためメールの取得処理の間隔を設定することができます。<br />
		※テスト時などこの機能を無効化したい場合には0を入力します。<br />
		デフォルト: 600 (10分)
	</td>
</tr>
<tr>
	<td>次回更新時刻(変更できません)</td>
	<td>
		この時刻以降に<code>&lt;Moblog&gt;</code>と記載されているページにアクセスするとメール取得処理を行う。<br />
		※表示用のため変更できません。
	</td>
</tr>
<tr>
	<td>ログを出力を行うか？</td>
	<td>
		<code>はい</code>にすることにより「管理者操作履歴」ログを記録するようになります。
		膨大なログが出力されるので動作確認時以外は<code>いいえ</code>にしておくことを推奨します。
		<code>いいえ</code>の場合であっても重大なエラーについては記録されます。<br />
		デフォルト: いいえ
	</td>
</tr>
</table>

<p>メンバーオプション（メンバーごとの設定）</p>
<table>
<tr>
	<th>オプション</th>
	<th>解説</th>
</tr>
<tr>
	<td>プラグインを有効にするか？</td>
	<td>
		<code>いいえ</code>の場合、このメンバーでメールの取得を行いません。<br />
		デフォルト: いいえ
	</td>
</tr>
<tr>
	<td>POP3 ホスト名</td>
	<td>メールを取得するメールサーバ名</td>
</tr>
<tr>
	<td>POP3 ポート</td>
	<td>
		メールを取得するメールサーバのポート。通常は変更しなくて大丈夫です<br />
		デフォルト: 110
	</td>
</tr>
<tr>
	<td>POP3 ユーザー名</td>
	<td>メールを取得するメールサーバのユーザ名</td>
</tr>
<tr>
	<td>POP3 パスワード</td>
	<td>メールを取得するメールサーバのパスワード</td>
</tr>
<tr>
	<td>APOPを使用するか？</td>
	<td>
		メール取得の際にAPOPを利用するかどうかを設定します。<br />
		デフォルト: いいえ
	</td>
</tr>
<tr>
	<td>画像を保存するディレクトリ</td>
	<td>
		画像を保存するディレクトリを指定します。<br />
		※デフォルト以外を利用する場合には、あらかじめmediaディレクトリ内にディレクトリを作成しておく必要があります。
	</td>
</tr>
<tr>
	<td>サムネイルを保存するディレクトリ</td>
	<td>
		サムネイルを保存するディレクトリを指定します。<br />
		※デフォルト以外を利用する場合には、あらかじめmediaディレクトリ内にディレクトリを作成しておく必要があります。
	</td>
</tr>
<tr>
	<td>Nucleusカテゴリ(Blog)</td>
	<td>
		メールをどのカテゴリ(blog)で投稿するか設定します。
	</td>
</tr>
<tr>
	<td>イメージ添付メールのみ追加？</td>
	<td>添付ファイルがある場合のみ、投稿を行います。添付ファイルがないメールは無視されます。</td>
</tr>
<tr>
	<td>デフォルトで公開するか？</td>
	<td>
		<code>いいえ</code>の場合には取得したメールをドラフトとして投稿します。投稿内容をドラフトにせずに即時に公開したい場合には設定を<code>はい</code>にします。<br />
		デフォルト: いいえ	
	</td>
</tr>
<tr>
	<td>オプション記述開始の区切り文字</td>
	<td>
		メールタイトルによってオプションを上書きする場合にオプションの始まりを示す文字。<br />
		デフォルト: @		
	</td>
</tr>
<tr>
	<td>オプションでblogidを指定する場合のキー</td>
	<td>
		メールタイトルによってオプションを上書きする場合に「Nucleus blog Id」を表すキー<br />
		デフォルト: b
	</td>
</tr>
<tr>
	<td>オプションでカテゴリを指定する場合のキー</td>
	<td>
		メールタイトルによってオプションを上書きする場合に「Nucleus カテゴリ名/カテゴリID」を表すキー<br />
		デフォルト: c
	</td>
</tr>
<tr>
	<td>オプションでストレートにpublish指定する場合のキー</td>
	<td>
		メールタイトルによってオプションを上書きする場合に「デフォルトで公開するか？」を表すキー<br />
		デフォルト: s
	</td>
</tr>
<tr>
	<td>追記にする場合の区切り文字(利用しない場合は空欄)</td>
	<td>
		メールの本文中に指定する文字列があった場合、にその文字列以降の部分が追記になります<br />
		デフォルト: (空欄)			
	</td>
</tr>
<tr>
	<td>投稿許可アドレス（複数の場合改行で区切ってください）</td>
	<td>
		投稿を許可するメールの送信元を指定します。ここで指定されない送信元からのメールは追加されません。<br />
		推奨しませんが*だけを書いた行を追加することで、不特定のユーザから投稿することが可能になります。不用意に使うとblogがSPAMだらけになる可能性がありますので十分注意してください。<br />
		デフォルト: (空欄)
	</td>
</tr>
<tr>
	<td>投稿許可SubjectPrefix(制限無しの場合は空欄)</td>
	<td>
		Subjectが特定の文字列から始まる場合にのみ投稿が行われます。この機能を利用しないとき空欄にしておいてください。<br />
		デフォルト: (空欄)
	</td>
</tr>
<tr>
	<td>件名がないときの題名</td>
	<td>
		メールのタイトルがない場合にここで設定した内容をタイトルとして利用します<br />
		デフォルト: (空欄)
	</td>
</tr>
<tr>
	<td>htmlメールの場合に除去しないタグ</td>
	<td>
		メールをHTML形式で送信した際に、除去しないタグを指定します<br />
		デフォルト: &lt;title&gt; &lt;hr&gt; &lt;h1&gt; &lt;h2&gt; &lt;h3&gt; &lt;h4&gt; &lt;h5&gt; &lt;h6&gt; &lt;div&gt; &lt;p&gt; &lt;pre&gt; &lt;sup&gt; &lt;ul&gt; &lt;ol&gt; &lt;br&gt; &lt;dl&gt; &lt;dt&gt; &lt;table&gt; &lt;caption&gt; &lt;tr&gt; &lt;li&gt; &lt;dd&gt; &lt;th&gt; &lt;td&gt; &lt;a&gt; &lt;area&gt; &lt;img&gt; &lt;form&gt; &lt;input&gt; &lt;textarea&gt; &lt;button&gt; &lt;select&gt; &lt;option&gt;
	</td>
</tr>
<tr>
	<td>最大添付量(B)</td>
	<td>
		添付ファイルを最大容量を指定します。これ以上の容量のファイルは追加されません。また、添付ファイルの最大容量はこれ以外の設定などによって制限を受ける場合があります<br />
		デフォルト: 300000
	</td>
</tr>
<tr>
	<td>対応MIMEタイプ(正規表現)</td>
	<td>
		添付ファイルのMIMEタイプがここで指定するパターンに該当する場合にのみ保存を行います。<br />
		デフォルト: gif|jpe?g|png|bmp|octet-stream|x-pmd|x-mld|x-mid|x-smd|x-smaf|x-mpeg|pdf
	</td>
</tr>
<tr>
	<td>保存しないファイル(正規表現)</td>
	<td>
		「対応MIMEタイプ」に該当する場合でも、ファイルがここで指定するパターンに該当する場合には添付ファイルは処理されません。<br />
		デフォルト: .+\.exe$|.+\.zip$|.+\.pif$|.+\.scr$
	</td>
</tr>
<tr>
	<td>画像ファイルの拡張子(正規表現)</td>
	<td>
		「対応MIMEタイプ」に該当し、ファイルがここで指定するパターンに該当する場合に、添付ファイルが画像ファイルと認識します。それ以外はデータファイルとみなされます。<br />
		デフォルト: .+\.png$|.+\.jpe?g$|.+\.gif$|.+\.bmp$
	</td>
</tr>
<tr>
	<td>サムネイルを使用する？</td>
	<td>
		サムネイルを自動的に作成するか指定します<br />
		デフォルト: はい
	</td>
</tr>
<tr>
	<td>サムネイルの大きさ(Width)</td>
	<td>
		生成されるサムネイルの最大横幅を指定します<br />
		デフォルト: 120
	</td>
</tr>
<tr>
	<td>サムネイルの大きさ(Hight)</td>
	<td>
		生成されるサムネイルの最大縦幅を指定します<br />
		デフォルト: 120
	</td>
</tr>
<tr>
	<td>サムネイルを作る対象画像</td>
	<td>
		サムネイル生成の対象となるファイル名のパターンを指定します<br />
		デフォルト: .+\.jpe?g$|.+\.png$
	</td>
</tr>
<tr>
	<td>アイテム内に表示する画像の最大横幅</td>
	<td>
		サムネイルを生成しない場合に、IMGタグに挿入される横幅を指定します<br />
		デフォルト: 120
	</td>
</tr>
<tr>
	<td>テキストテンプレート</td>
	<td>
		添付ファイルがない場合に使われるテンプレートです<br />
		テンプレート内で使えるタグについては別途解説してあります
	</td>
</tr>
<tr>
	<td>サムネイル付きテンプレート</td>
	<td>
		サムネイルを使うように設定してあり、なおかつサムネイルがきちんと生成できた場合に使われるテンプレートです<br />
		テンプレート内で使えるタグについては別途解説してあります
	</td>
</tr>
<tr>
	<td>サムネイルなしテンプレート</td>
	<td>
		サムネイルを使わないように設定していて、画像の横幅が「アイテム内に表示する画像の最大横幅」を超えない場合、もしくは「対応MIMEタイプ」に含まれるが「サムネイルを作る対象画像」に該当する場合に使われるテンプレートです。<br />
		テンプレート内で使えるタグについては別途解説してあります
	</td>
</tr>
<tr>
	<td>サムネイルなしテンプレート(縮小)</td>
	<td>
		サムネイルを使わないように設定していて、画像の横幅が「アイテム内に表示する画像の最大横幅」を超える場合に使われるテンプレートです<br />
		テンプレート内で使えるタグについては別途解説してあります
	</td>
</tr>
<tr>
	<td>データファイルテンプレート</td>
	<td>
		画像以外の添付ファイルがあるときに使われるテンプレートです<br />
		テンプレート内で使えるタグについては別途解説してあります
	</td>
</tr>
</table>

<h3>テンプレート内で利用可能なタグ</h3>

<p>テンプレート中には以下のタグが利用できます。</p>
<p>(テンプレートによっては使えないものもあります)</p>

<table>
<tr>
	<th>タグ</th>
	<th>解説</th>
</tr>
<tr>
	<td>&lt;%sizeW%&gt;</td>
	<td>オリジナル画像の横幅</td>
</tr>
<tr>
	<td>&lt;%sizeH%&gt;</td>
	<td>オリジナル画像の縦幅</td>
</tr>
<tr>
	<td>&lt;%thumbW%&gt;</td>
	<td>生成されたサムネイルの横幅</td>
</tr>
<tr>
	<td>&lt;%thumbH%&gt;</td>
	<td>生成されたサムネイルの縦幅</td>
</tr>
<tr>
	<td>&lt;%reductionW%&gt;</td>
	<td>画像を縮小表示するときの横幅</td>
</tr>
<tr>
	<td>&lt;%reductionH%&gt;</td>
	<td>画像を縮小表示するときの縦幅</td>
</tr>
<tr>
	<td>&lt;%thumbUrl%&gt;</td>
	<td>生成されたサムネイルのURL</td>
</tr>
<tr>
	<td>&lt;%imageUrl%&gt;</td>
	<td>オリジナル画像（添付ファイル）のURL</td>
</tr>
<tr>
	<td>&lt;%mediaUrl%&gt;</td>
	<td>mediaディレクトリのURL</td>
</tr>
<tr>
	<td>&lt;%fileName%&gt;</td>
	<td>添付ファイルのファイル名</td>
</tr>
<tr>
	<td>&lt;%body%&gt;</td>
	<td>メールの本文</td>
</tr>
</table>

<h3>サポートとバグレポート</h3>

<p>問題が解決できない場合には<a href="http://japan.nucleuscms.org/bb/">Nucleus(JP)フォーラム</a>を活用しましょう。</p>
<p>バグレポートについては配布元の<a href="http://blog.cles.jp/np_cles/">NP_cles()</a>にて受け付けていますので、該当のバージョンのエントリにコメント又はトラックバックでどうぞ。</p>
<p>「動作確認しました」というだけでも開発者には重要な情報になります。</p>

<h3>アンインストール</h3>

<p><code>NP_Moblog</code>を完全にアンインストールするための手順は以下の通りです</p>

<ol>
  <li>「プラグイン管理」からNP_Moblogをアンインストールする</li>
  <li>Nucleusをインストールしているサーバの<code>nucleus/plugin/</code>ディレクトリから<code>NP_Moblog.php</code>と<code>moblog</code>ディレクトリを削除する</li>
</ol>

<h3>バージョン履歴</h3>

<p>新バージョンは<a href="http://blog.cles.jp/np_cles/">NP_cles()</a>で確認してください。</p>

<ul>
	<!--  
	<li>　//TODO: [Fixed] 日本語のファイル添付に対応 </li>
	-->

	<li>Version 1.17: (2010/06/06)</li>
	<li>　[Fixed] エンコーディングが適切に検出されない問題を修正</li>
	<li>　[Fixed] mysql_query()をsql_query()に変更</li>
	<li>　[Fixed] eregi()をpreg_match()に変更</li>
	<li>　[Fixed] register_globals,allow_url_fopen,allow_url_includeがonの場合にリモートコードインジェクションが発生する問題に対応しました (Thanks Katsumiさん)</li>
	<li>Version 1.16: (2007/03/17)</li>
	<li>　[Fixed] メールアドレスの大文字小文字を区別しないようにした</li>
	<li>　[Fixed] 管理者が設定の変更を行った場合、useridディレクトリにきちんと画像が保存されない問題を修正</li>
	<li>Version 1.15: (2006/09/30)</li>
	<li>　[Fixed] セキュリティの向上</li>
	<li>Version 1.14: (2006/07/15)</li>
	<li>　[Added] 画像・サムネイルの保存先を指定できるようにした</li>
	<li>　[Fixed] ファイル名のPrefixをuniqid()からYYYYmmddHHiissnn形式（日付＋連番）に変更した</li>
	<li>　[Fixed] ユーザーがSuper-Adminである場合に任意のBlog、カテゴリで投稿できる問題を修正</li>
	<li>　[Fixed] ブログ名、カテゴリ名に特定の文字が入っている場合に、投稿が出来ない問題を修正</li>
	<li>Version 1.13: (2006/03/24)</li>
	<li>　[Fixed] HTMLメールが上手く扱えない問題を修正</li>
	<li>Version 1.12: (2005/03/19)</li>
	<li>　[Fixed] ライセンスを変更した</li>
	<li>Version 1.11: (2005/12/30)</li>
	<li>　[Fixed] マニュアルの誤記、XHTMLに準拠していなかった部分を修正</li>
	<li>　[Fixed] PEARファイル群のinclude()の方法を改善</li>
	<li>Version 1.10: (2005/09/01)</li>
	<li>　[Fixed] 「イメージ添付メールのみ追加？」が「はい」の場合に、添付ファイルが存在しているにもかかわらず、エントリが追加されない不具合を修正</li>
	<li>　[Added] 管理画面から動作確認ができる機能を追加</li>
	<li>Version 1.9: (2005/09/01)</li>
	<li>　[Changed] 「Nucleus blog Id」「Nucleus カテゴリ名/カテゴリID」を「Nucleusカテゴリ名(Blog名)」変更</li>
	<li>Version 1.8: (2005/07/25)</li>
	<li>　[Fixed] PEARクラスのinclude()方法を変更した</li>
	<li>Version 1.7: (2005/07/07)</li>
	<li>　[Fixed] 1.6で修正されていなかったオプション分割の不具合を修正</li>
	<li>Version 1.6: (2005/07/02)</li>
	<li>　[Added] テキストテンプレート（添付ファイルがない場合のテンプレート）を追加</li>
	<li>　[Added] SPAM Checkに対応(別途、NP_BlackListなどが必要です)</li>
	<li>　[Added] Help(このファイル)を同梱</li>
	<li>　[Fixed] オプション分割の不具合を修正</li>
	<li>　[Fixed] Nucleus v3.2以前のバージョンにインストールできないようにした。(getMinNucleusVersionを設定)</li>
</ul>

<h3>Special Thanks</h3>

<p>NP_Moblogははまみおさんの<a href="http://nakahara21.com/?itemid=133">NP_HeelloWorld v0.8</a>を基に開発しました。原作者のまみおさんに感謝します。</p>

<h3>開発者について</h3>

<ul>
  <li><a href="http://blog.cles.jp/member/1">hsur</a> (<a href="http://blog.cles.jp/">cles::blog</a>)</li>
  <li>配布元： <a href="http://blog.cles.jp/np_cles/category/31/subcatid/2">NP_cles() - NP_Moblog</a></li>
  <li><a href="http://blog.cles.jp/np_cles/"><img border="0" src="http://blog.cles.jp/npmoblog.png"  alt="Powered by NP_Moblog" /></a> ← ご自由にご利用ください。</li>
  <li>ドネーションや仕事のご依頼も歓迎します。</li>
</ul>
